{% extends 'base.html' %}
{% load static %}
{% block title %}
    Ovoz Berish
{% endblock %}

{% block link %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- ApexCharts kutubxonasini qo'shish -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
    <main>
        <section class="py-4 py-lg-6 bg-secondary">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-12">
                        <h1 class="text-white mb-1 display-4">Ovoz berishni boshlash</h1>
                    </div>
                </div>
            </div>
        </section>
        <section class="pt-5 pb-5">
            <div class="container">
                <div class="row mt-0 mt-md-4">
                    <div class="col-sm-12 col-md-12 mb-3">
                        <div class="card border-0 mb-3">
                            <div class="card-body" id="teacher_data">
                                <!-- Ovoz berish ma'lumotlari bu yerga keladi -->
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="card border-0">
                            <div class="card-body p-10">
                                <div class="table-responsive">
                                    <table class="table mb-0 text-nowrap table-hover table-centered">
                                        <thead>
                                        <tr style="font-size: 20px">
                                            <th>#</th>
                                            <th>F.I.SH</th>
                                            <th>Boshlash</th>
                                        </tr>
                                        </thead>
                                        <tbody id="employee_table">
                                        {% for employee in selected_employees %}
                                            <tr data-id="{{ employee.id }}">
                                                <td>{{ forloop.counter }}</td>
                                                                <td class="px-0">
                                                                    <div class="d-flex align-items-center gap-3">
                                                                        <div class="avatar avatar-lg">
                                                                            <img alt="avatar" src="{{ employee.employee.image }}" class="rounded-circle"/>
                                                                        </div>
                                                                        <div>
                                                                            <h4 class="mb-0">{{ employee.employee.full_name }}</h4>
                                                                            <h5 class="text-secondary mb-0">{{employee.employee.position}}</h5>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                <td>
                                                    <button class="btn btn-sm start-btn btn-success w-50"
                                                            data-id="{{ employee.id }}"
                                                            data-fullname="{{ employee.employee.full_name }}"
                                                            {% if employee.voted %}
                                                            disabled
                                                            class="btn btn-light"
                                                            {% elif employee.status %}
                                                            class="btn btn-danger"
                                                            {% else %}
                                                            class="btn btn-success"
                                                            {% endif %}>
                                                        {% if employee.voted %}
                                                            Yakunlandi
                                                        {% elif employee.status %}
                                                            Stop
                                                        {% else %}
                                                            Start
                                                        {% endif %}
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <a href="{% url 'teachers:get_result' %}" class="btn btn-secondary">Barcha natijalar</a>
                </div>
            </div>
        </section>
    </main>

    <script>
        $(document).ready(function () {
            let activeEmployeeId = null;
            let voteUpdateInterval = null;
            let latestVoteData = null; // So'nggi ovoz berish ma'lumotlarini saqlash

            // Har 5 sekundda ma'lumotlarni yangilashni boshlash
            function startVoteUpdate() {
                if (!voteUpdateInterval) {
                    voteUpdateInterval = setInterval(function () {
                        $.ajax({
                            url: "{% url 'teachers:get_vote_data' %}",
                            type: 'GET',
                            success: function (response) {
                                if (response.status === 'success') {
                                    latestVoteData = response; // Ma'lumotlarni saqlash
                                    updateTeacherData(response);
                                } else {
                                    clearTeacherData();
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error('Vote data AJAX error:', error);
                            }
                        });
                    }, 5000);
                }
            }

            // Yangilanishni to'xtatish
            function stopVoteUpdate() {
                if (voteUpdateInterval) {
                    clearInterval(voteUpdateInterval);
                    voteUpdateInterval = null;
                }
            }

            // Sahifa yuklanganda agar faol bo'lsa yangilanishni boshlash
            const activeButton = $('.start-btn.btn-danger');
            if (activeButton.length > 0) {
                disableOtherButtons(activeButton);
                activeEmployeeId = activeButton.data('id');
                startVoteUpdate();
            }

            // Tugma hodisasi
            $('.start-btn').click(function () {
                const $button = $(this);
                const employeeId = $button.data('id');
                const isStarting = $button.text().trim() === 'Start';
                const isStopping = $button.text().trim() === 'Stop';

                if ($button.text().trim() === 'Yakunlandi') return;

                $button.prop('disabled', true);

                if (isStarting) {
                    $.ajax({
                        url: "{% url 'teachers:update_employee_status' %}",
                        type: 'POST',
                        data: {
                            'employee_id': employeeId,
                            'status': true,
                            'voted': false,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function (response) {
                            if (response.status === 'success') {
                                $button.text('Stop')
                                    .removeClass('btn-success')
                                    .addClass('btn-danger')
                                    .prop('disabled', false);
                                disableOtherButtons($button);
                                activeEmployeeId = employeeId;
                                startVoteUpdate();
                            } else {
                                $button.prop('disabled', false);
                                alert('Xatolik yuz berdi: ' + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            $button.prop('disabled', false);
                            alert('Server bilan bogâ€˜lanishda xatolik yuz berdi');
                            console.error('AJAX error:', error);
                        }
                    });
                } else if (isStopping) {
                    $button.text('Yakunlash')
                        .removeClass('btn-danger')
                        .addClass('btn-warning')
                        .prop('disabled', false);
                    stopVoteUpdate();
                    showFinalData();
                } else if ($button.text().trim() === 'Yakunlash') {
                    $.ajax({
                        url: "{% url 'teachers:update_employee_status' %}",
                        type: 'POST',
                        data: {
                            'employee_id': employeeId,
                            'status': false,
                            'voted': true,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function (response) {
                            if (response.status === 'success') {
                                $button.text('Yakunlandi')
                                    .removeClass('btn-warning')
                                    .addClass('btn-light')
                                    .prop('disabled', true);
                                enableAllButtons();
                                activeEmployeeId = null;
                                clearTeacherData();
                            } else {
                                $button.prop('disabled', false);
                                alert('Xatolik yuz berdi: ' + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            $button.prop('disabled', false);
                            alert('Server bilan bogâ€˜lanishda xatolik yuz berdi');
                            console.error('AJAX error:', error);
                        }
                    });
                }
            });

            // Boshqa tugmalarni disable qilish funksiyasi
            function disableOtherButtons($currentButton) {
                $('.start-btn').each(function () {
                    const $btn = $(this);
                    if ($btn.data('id') !== $currentButton.data('id') && $btn.text().trim() === 'Start') {
                        $btn.prop('disabled', true);
                    }
                });
            }

            // Barcha tugmalarni enable qilish funksiyasi
            function enableAllButtons() {
                $('.start-btn').each(function () {
                    const $btn = $(this);
                    if ($btn.text().trim() === 'Start') {
                        $btn.prop('disabled', false);
                    }
                });
            }

            // Teacher data ni yangilash
            function updateTeacherData(data) {
                const totalVotes = data.votes[0] + data.votes[1] + data.votes[2];
                $('#teacher_data').html(`
                    <div class="row">
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <img src="${data.image}" alt="course" style="width: 200px" class="rounded">
                                <div class="ms-3">
                                    <h3 class="mb-0 border-bottom"><a href="#" class="text-inherit">${data.full_name}</a></h3>
                                    <div>
                                        <h4>Tugâ€˜ilgan yili: <span class="text-secondary">${data.birth_date}</span></h4>
                                        <h4>Kafedra: <span class="text-secondary">${data.chair}</span></h4>
                                        <h4>Lavozimi: <span class="text-secondary">${data.position}</span></h4>
                                        <h4>Ilmiy daraja: <span class="text-secondary">${data.degree}</span></h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 d-flex justify-content-center align-items-center" id="vote_summary">
                            <div class="text-center" id="show_all_data">
                                <h1 style="font-size: 58px">${totalVotes}</h1>
                                <h2 class="text-secondary">Nafar kishi ovoz berdi</h2>
                            </div>
                        </div>
                    </div>
                `);
            }

            // Yakuniy ma'lumotlarni pie chart bilan ko'rsatish
            function showFinalData() {
                const $voteSummary = $('#vote_summary');
                if (!latestVoteData) return; // Agar ma'lumotlar hali yuklanmagan bo'lsa, hech narsa qilma

                const voteList = [latestVoteData.votes[0], latestVoteData.votes[1], latestVoteData.votes[2]];
                let options = {
                    series: voteList,
                    chart: {
                        width: 420,
                        type: 'pie',
                    },
                    labels: ['Qarshi', 'Rozi', 'Betaraf'],
                    legend: {
                        position: 'bottom',
                        fontSize: '16px',
                    },
                    plotOptions: {
                        pie: {
                            dataLabels: {
                                offset: -30,
                            },
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: function (val, opts) {
                            let total = voteList.reduce((acc, curr) => acc + curr, 0);
                            let count = voteList[opts.seriesIndex];
                            return `${count} ta (${val.toFixed(1)}%)`;
                        },
                        style: {
                            fontSize: '18px',
                            fontWeight: 'bold',
                            colors: ['#fff']
                        }
                    },
                    responsive: [{
                        breakpoint: 480,
                        options: {
                            chart: {width: 200},
                            legend: {position: 'bottom'}
                        }
                    }]
                };

                $voteSummary.html(`
                    <div class="text-center">
                        <div id="chart"></div>
                    </div>
                `);
                const chart = new ApexCharts(document.querySelector("#chart"), options);
                chart.render();
            }

            // Teacher data ni tozalash
            function clearTeacherData() {
                $('#teacher_data').html('');
            }
        });
    </script>
{% endblock %}